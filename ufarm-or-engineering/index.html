<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>uFarm | Engineering | Garrett Dowd</title><meta name="description" content="This is the third article in a series about the uFarm product design process. The series delves into three distinct&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://blog.garrettdowd.com/ufarm-or-engineering/"><link rel="alternate" type="application/atom+xml" href="https://blog.garrettdowd.com/feed.xml"><link rel="alternate" type="application/json" href="https://blog.garrettdowd.com/feed.json"><link rel="shortcut icon" href="https://blog.garrettdowd.com/media/website/favicon.svg" type="image/png"><link rel="shortcut icon" href="https://blog.garrettdowd.com/media/website/favicon.svg" type="image/png"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://blog.garrettdowd.com/assets/css/style.css?v=1d0a60675ce739a1c7da99da8800471f"><link rel="stylesheet" href="https://blog.garrettdowd.com/assets/css/photoswipe.css?v=ffb247881cd6f611d007fd4a96b7b16a"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.garrettdowd.com/ufarm-or-engineering/"},"headline":"uFarm | Engineering","datePublished":"2020-09-09T14:38","dateModified":"2020-09-16T08:35","image":{"@type":"ImageObject","url":"https://blog.garrettdowd.com/media/posts/27/IMG_5867-2.jpg","height":898,"width":673},"description":"This is the third article in a series about the uFarm product design process. The series delves into three distinct&hellip;","author":{"@type":"Person","name":"Garrett Dowd"},"publisher":{"@type":"Organization","name":"Garrett Dowd","logo":{"@type":"ImageObject","url":"https://blog.garrettdowd.com/media/website/Garrett-Dowd-SF-2-01-svg.svg","height":560,"width":960}}}</script><style>.pswp--svg .pswp__button,
				          .pswp--svg .pswp__button--arrow--left:before,
				          .pswp--svg .pswp__button--arrow--right:before {
					          background-image: url(https://blog.garrettdowd.com/assets/svg/gallery-icons-light.svg);
			              }</style><script type="application/ld+json">{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{ "@type": "ListItem", "position": 1, "name": "Home", "item": "https://blog.garrettdowd.com/" },{ "@type": "ListItem", "position": 2, "name": "Projects", "item": "https://blog.garrettdowd.com/t/projects/" }] }</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-100486788-3"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-100486788-3');</script></head><body><header class="header" id="js-header"><a href="https://blog.garrettdowd.com/" class="logo"><img src="https://blog.garrettdowd.com/media/website/Garrett-Dowd-SF-2-01-svg.svg" alt="Garrett Dowd"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="[MISSING TRANSLATION]"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">[MISSING TRANSLATION]</span></span></button><ul class="navbar__menu"><li><a href="https://blog.garrettdowd.com/t/product-management/" target="_self">View Portfolio</a></li><li><a href="https://blog.garrettdowd.com/t/projects/" target="_self">Explore Projects</a></li><li><a href="https://www.linkedin.com/in/garrettdowd/" target="_blank">Connect on Linkedin</a></li><li><a href="https://github.com/garrettdowd" target="_blank">Collab on Github</a></li><li><a href="https://blog.garrettdowd.com/" target="_self">View All</a></li></ul></nav></header><main class="main main--post"><article class="post"><header class="hero post__header"><div class="wrapper wrapper--narrow"><ol class="breadcrumb"><li><a href="https://blog.garrettdowd.com/"><span>Home</span></a></li><li><span>&rsaquo;</span> <a href="https://blog.garrettdowd.com/t/projects/" title="Projects"><span>Projects</span></a></li></ol><h1 class="post__title">uFarm | Engineering</h1><div class="post__meta"><time datetime="2020-09-09T14:38">September 9, 2020</time></div></div></header><div class="wrapper main__content post__inner"><figure class="post__featured-image"><img src="https://blog.garrettdowd.com/media/posts/27/IMG_5867-2.jpg" srcset="https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-2-xs.jpg 384w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-2-sm.jpg 600w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-2-md.jpg 768w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-2-lg.jpg 1200w" sizes="(max-width: 2560px) 100vw, 2560px" loading="eager" height="898" width="673" alt=""></figure><div class="post__entry"><p>This is the third article in a series about the uFarm product design process. The series delves into three distinct areas of the design process;</p><ol><li><a href="https://blog.garrettdowd.com/designing-ufarm/">Product | Building a useful product that actually solves problems.</a></li><li><a href="#non-existing-post-with-id-26">Aquaponics | Plant science turned into design parameters.</a> (Coming mid-September)</li><li>Engineering | Iterative design of a cyber-physical system.</li></ol><p>The series will end with;</p><ol><li><a href="#non-existing-post-with-id-25">Outcomes | Running and testing the prototype.</a> (coming mid-September)</li><li><a href="#non-existing-post-with-id-25">Build Log | Pictures and comments from the process.</a> (coming mid-September)</li></ol><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1ehagmm3s10j">System Architecture</a><ul><li><a href="#mcetoc_1ehagmm3s10k">Plant Productivity</a></li><li><a href="#mcetoc_1ehagmm3s10l">Energy Use</a></li><li><a href="#mcetoc_1ehagmm3s10m">Maintenance</a></li><li><a href="#mcetoc_1ehcngpen15p">Result</a></li></ul></li><li><a href="#mcetoc_1ehcngpen15q">Parametric Design</a></li><li><a href="#mcetoc_1ehcpsmpj1cq">Mechanical Design</a><ul><li><a href="#mcetoc_1ehcpsmpj1cr">Stress/Strain Analysis</a></li><li><a href="#mcetoc_1ehcpsmpj1cs">Fluid Dynamics | Plumbing</a></li></ul></li><li><a href="#mcetoc_1ehd2spl720d">Actuation and Control</a><ul><li><a href="#mcetoc_1ehd2spl720e">Fluid Flow</a><ul><li><a href="#mcetoc_1ehd2spl720f">Pump Sizing</a></li><li><a href="#mcetoc_1ehd2spl720g">Actuated Valve Choices</a></li></ul></li><li><a href="#mcetoc_1ehd2spl720h">HVAC</a></li><li><a href="#mcetoc_1ehq2ka111dm">Controller</a></li></ul></li><li><a href="#mcetoc_1ehcpsmpj1ct">Electrical Design</a><ul><li><a href="#mcetoc_1ehcpsmpj1cv">Light</a><ul><li><a href="#mcetoc_1ehq2ka111dn">Brightness</a></li><li><a href="#mcetoc_1ehq2ka111do">Designing for PPFD</a></li></ul></li><li><a href="#mcetoc_1ehcpsmpj1d0">Power/Signal Distribution</a></li><li><a href="#mcetoc_1ehq2ka111dp">Component Stack</a></li></ul></li><li><a href="#mcetoc_1ehcpsmpj1d1">Software</a></li><li><a href="#mcetoc_1ehq2ka111dq">Future Updates</a></li></ul></div><h2 id="mcetoc_1ehagmm3s10j">System Architecture</h2><p>There is an infinite number of ways to design an aquaponic system. This section will dive in the guiding principles, based on <a href="#non-existing-post-with-id-26">aquaponic science</a>, that reduce the size of the design domain.</p><p>uFarm is heavily influenced by proven design architectures from commercial aquaponic systems. Commercial systems are designed to maximize productivity and reduce costs. The relevant optimization goals for a personal grow system roughly include</p><ul><li>Maximize Plant Productivity</li><li>Minimize Energy Use</li><li>Minimize Maintenance</li></ul><h3 id="mcetoc_1ehagmm3s10k">Plant Productivity</h3><p>How do you fit the most number of plants into the smallest footprint possible? Easy, you build a vertical grow system and you space the plants as closely as possible. Productivity becomes a challenge of space optimization. Space optimization is surprisingly difficult, just ask mathematicians about circle/sphere packing. However, space can also be saved by using a single component for multiple uses. uFarm optimizes space by;</p><ul><li>Using the media grow bed as a bio-filter that houses the nitrifying bacterial colony.</li><li>Using the pump to also aerate the water (increase dissolved oxygen)</li><li>Using the DWC grow bed as a water reservoir</li><li>Using the media bed as a particle filter for the DWC grow bed</li></ul><h3 id="mcetoc_1ehagmm3s10l">Energy Use</h3><p>Besides HVAC, the biggest energy drains are water pumps and grow lights.</p><p>Water is heavy and water pumps are inefficient. However, water pumps increase in efficiency (Litre/Watt) as pump size increases. This leads to a common design architecture called CHOP, constant height one pump. CHOP means that water is pumped from its lowest potential energy to its highest potential energy in a single place; gravity does the rest. Having a single pump also reduces maintenance and an additional pump can be added in parallel for redundancy. While a vertical grow system is obviously not at a constant height, uFarm uses only one pump for complete system recirculation.</p><p>Light is not so simple to optimize. Generally speaking there are two system design concerns for lighting, uniformity and heat. Lighting uniformity can be improved by using lenses or diffusers, both of which have downsides. Lighting uniformity can also be increased by increasing the number of light sources, such as LED strips or arrays. </p><p>Every light source also produces heat (radiated and convected) that needs to be managed. Convective heat transfer methods (big fans) are commonly used to move hot air out of the grow area and prevent tip burn caused by radiated heat. Because height is limited in vertical growing (tip burn is a concern), LEDs and florescents are commonly used because they emit less infrared radiation. </p><h3 id="mcetoc_1ehagmm3s10m">Maintenance</h3><p>The most labor intensive maintenance is cleaning. There are three ways to reduce maintenance cost/time.</p><ol><li>Design for easy cleaning<ol><li>make system easy to disassemble or access areas that need cleaned</li></ol></li><li>Design to reduce frequency of cleaning<ol><li>Limit light exposure to prevent algae and other unwanted/harmful growth</li><li>Increase size of the particle filter</li></ol></li><li>Design for self-cleaning<ol><li>Add vermiculture to the particle filter to break down physical waste</li><li>Add bottom feeders, such as plecostomus, to manage algae growth</li></ol></li></ol><h3 id="mcetoc_1ehcngpen15p">Result</h3><p>The engineering principles/constraints were mingled with product specifications over a few iterations of product sketches and parametric studies. Ultimately the architecture seen below was chosen for the initial prototype.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/IMG_5867.jpg" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-xs.jpg 384w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-sm.jpg 600w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-md.jpg 768w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5867-lg.jpg 1200w" alt=""></figure><h2 id="mcetoc_1ehcngpen15q">Parametric Design</h2><p>Defining the overall direction for system architecture is an iterative process. Parametric design allows each iteration to be analyzed and optimized more quickly. There are well over a hundred quantitative parameters that can be defined for a vertical aquaponic system. Therefore, constraints need to be applied to reduce the number of free parameters. A simplified equation-based approach was taken for the prototype design that used the following variables.</p><table style="width: 716px;" width="400"><tbody><tr><td style="width: 301px;"><strong>Constraints</strong></td><td style="width: 254px;"><strong>Dependent Parameters</strong></td><td style="width: 161px;"><strong>Optimization</strong></td></tr><tr><td style="width: 301px;" width="272">Media Grow Bed Length (in|m)</td><td style="width: 254px;" width="230">Feed Rate (lb/month|g/day)</td><td style="width: 161px;" width="64">Grow Area (ft^2|m^2)</td></tr><tr><td style="width: 301px;">Media Grow Bed Width (in|m)</td><td style="width: 254px;">Fish Weight (lb|kg)</td><td style="width: 161px;">Weight (lb|kg)</td></tr><tr><td style="width: 301px;">Media Grow Bed Media Height (in|m)</td><td style="width: 254px;">Fish Stock (# fish)</td><td style="width: 161px;">Cost ($)</td></tr><tr><td style="width: 301px;">Equivalent Bio-filtration Volume Factor</td><td style="width: 254px;">Min Fish Tank Size (gal|L)</td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Media Packing Efficiency</td><td style="width: 254px;">Water Filtration Volume (gal|L)</td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Number of Modules</td><td style="width: 254px;">Sump Tank Safety Factor</td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Ebb and Flow Duty Cycle</td><td style="width: 254px;">Min Sump Tank Volume (gal|L)</td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">DWC Grow Bed Length (in|m)</td><td style="width: 254px;">Min Sump Flow Rate (gph|Lph)</td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">DWC Grow Bed Width (in|m)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">DWC Water Height (in|m)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Expected Fish Feed Rate (g/m^2/day)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Maximum Fish Density (lb/gal|kg/L)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Harvest Weight of Fish (lb/fish|kg/fish)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Feed BWR (body weight ratio)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Max Desired PPFD (umol/m^2/s)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">LED Lm/Watt</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">PPF/Lm Conversion Factor</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">LED Brightness %</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Cost of OSB ($/ft^2)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Cost of LECA (Hydroton) ($/L)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr><tr><td style="width: 301px;">Cost of gravel ($/ft^3)</td><td style="width: 254px;"> </td><td style="width: 161px;"> </td></tr></tbody></table><p> </p><h2 id="mcetoc_1ehcpsmpj1cq">Mechanical Design</h2><p> </p><h3 id="mcetoc_1ehcpsmpj1cr">Stress/Strain Analysis</h3><p>There is nothing too novel about the mechanical loading analysis. An "off the shelf" heavy-duty rack was used as the main support structure. This rack came with a per shelf maximum load of 800lbs (or 4000lbs total load) of "evenly distributed weight". I contacted the manufacturer to get more details on how this load rating was determined, but they were unable to provide any reasoning (or safety factors). A shelf system is an over-constrained system, so simple analysis could not be conducted to verify their load rating or determine a safety factor.</p><p>Luckily, the aquaponic system design does approximately distribute its weight evenly, so no further stress analysis was deemed necessary (I was really hoping to apply some principles from statics here).</p><p>However, strain is a large concern. The heavy duty rack is made of metal beams and particle board shelves. These components have relatively low Young's moduli (stiffness) when compared to the glass of the fish tank. This means that the shelf will sag (strain) a greater amount than the fish tank which leads to uneven support of the tank. This is bad because the fish tank design assumes uniform support around the edges, which is critical to reduce stress concentrations. Traditional tempered glass does not bend well! Therefore, additional support was added to increase the stiffness. A strain constrained analysis found that 2x4 wood beams would reduce the mid point sag to &lt;1mm. This was deemed acceptable without redoing the fish tank analysis/design.</p><p>A fish tank is also an over-constrained system. Unlike the shelf system, there are publicly available finite element modelling efforts to determine areas of max stress/strain in a glass aquarium. Max strain can be reduced by using a commonly used technique called cross-bracing, where a cross support is added to the middle of the tank. There are downsides to cross bracing which include poor aesthetics and reduced tank access for cleaning and management. There is another commonly used method of reducing max strain called euro-bracing, where thin, perpendicular strips of glass are added to the top rim of the tank. This uses the same principle as an I-beam to increase the second moment of area (increase equivalent stiffness). Euro-bracing was used for mostly aesthetic reasons.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-columns="2"><figure class="gallery__item"><a href="https://blog.garrettdowd.com/media/posts/27/gallery/SOLIDWORKS-1526397355918.png" data-size="791x594"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/gallery/SOLIDWORKS-1526397355918-thumbnail.png" alt="" width="768" height="577"></a></figure><figure class="gallery__item"><a href="https://blog.garrettdowd.com/media/posts/27/gallery/SOLIDWORKS-1526397368845.png" data-size="815x615"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/gallery/SOLIDWORKS-1526397368845-thumbnail.png" alt="" width="768" height="580"></a></figure></div></div><figure class="post__image post__image--center"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/IMG_5479.jpg" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5479-xs.jpg 384w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5479-sm.jpg 600w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5479-md.jpg 768w, https://blog.garrettdowd.com/media/posts/27/responsive/IMG_5479-lg.jpg 1200w" alt=""><figcaption>Eurobracing can be seen along the top length of the aquarium</figcaption></figure><p> </p><h3 id="mcetoc_1ehcpsmpj1cs">Fluid Dynamics | Plumbing</h3><p>Out of all the areas of engineering science, fluid dynamics is the least understood. Many of the design tools use empirical relationships that have fairly large margins of error.</p><p>The are a number of simplifications and assumptions that need to be made to analyze the plumbing requirements of the prototype. As designed, the prototype is non-pressurized and frequently switches between open channel and regular pipe flow. This means that there will be significant changes in fluid flow rate as the pipe transitions between open channel and pipe flow, however maximum flow rate is determined by the pipe flow regime.</p><p>Since the system is not pressurized the maximum rate of fluid flow in the pipe flow regime is determined by gravity (change in height) and is significantly impacted by friction losses within the pipe/tube. Therefore, the Darcy-Weisbach equation was used to determine the minimum diameter pipe that would satisfy the flow rate requirements from the parametric design stage. Because Darcy-Weisbach is an implicit function for pipe diameter, an iterative analysis approach was implemented via a <a href="https://github.com/garrettdowd/ufarm/blob/master/System%20Design.xlsx" target="_blank" rel="noopener noreferrer">spreadsheet</a>.</p><p>Another point of consideration is pipe fouling due to biological growth. This will increase the equivalent "surface roughness" of the pipe over time which will in turn decrease the maximum flow rate. Therefore it is safer to oversize the pipe, or use a larger safety factor.</p><p>Once a reasonable pipe diameter is determined, fittings can be chosen so that the plumbing system is easy to put together and remains water tight. This is not a fun process as there are a variety of materials, thread standards, and fitting types.</p><ul><li>Material that is rated for "cold" potable water is the ideal choice. Certifications depend on country, e.g. NSF-61</li><li>Flexible tubing (LLDPE or Vinyl) is easier to route than rigid piping (PVC)</li><li>NPT is the common standard for PVC pipe fittings in the U.S.. Barb fittings are the cheapest for flexible (non-pressurized) tubing</li></ul><figure class="post__image post__image--center"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/Aquaponics-Plumbing-Diagram.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponics-Plumbing-Diagram-xs.png 384w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponics-Plumbing-Diagram-sm.png 600w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponics-Plumbing-Diagram-md.png 768w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponics-Plumbing-Diagram-lg.png 1200w" alt=""></figure><h2 id="mcetoc_1ehd2spl720d">Actuation and Control</h2><h3 id="mcetoc_1ehd2spl720e">Fluid Flow</h3><p>Control of fluid flow is achieved with a submerged pump and direct action solenoid valves.</p><h4 id="mcetoc_1ehd2spl720f">Pump Sizing</h4><p>Pump sizing is based on the desired flowrate and head (the height at zero pressure). A good pump curve will give the relationship between flowrate and head while plotting constant efficiency and power curves, although these specifications can be hard to find at pumps targeted at consumers (less than 1HP or 1kW).</p><figure class="post__image post__image--center"><img loading="lazy" src="https://www.pumpsandsystems.com/sites/default/files/article/2018-04-26%2010%3A12/pumpcurve.png" data-is-external-image="true" alt="" width="372" height="256"></figure><p>Based on the height of the grow system and the estimated losses from friction in the pipe and fittings, the pump head was determined to be approximately 10 feet and the minimum flowrate determined by parametric design was 100 gallons per hour (3 meters at 400 litres per hour). Again, pump fouling from biological growth can reduce pump performance</p><h4 id="mcetoc_1ehd2spl720g">Actuated Valve Choices</h4><ul><li>Solenoid Valve<ul><li>There are a variety of solenoid valves targeted at a range of different fluid types and pressures. Nearly all solenoid valves are fully on or fully off and come in "normally open" and "normally closed" configurations. For non-pressurized liquid, direct action valves are the best option, although their energy requirements are much larger. Be wary of the cheapest solenoid valves that are generally designed for pressurized fluid (40-60psi).</li></ul></li><li>Ball Valve<ul><li>These are traditional ball valves with an added stepper motor that can adjust the rate of fluid flow through the valves. These things are expensive.</li></ul></li></ul><h3 id="mcetoc_1ehd2spl720h">HVAC</h3><p>There is minimal HVAC engineering in this prototype. While temperature and humidity are important growing parameters, the cost to implement a full HVAC system is prohibitive. However, this system is designed for use in a temperature and humidity controlled environment, an apartment. When combining thermal output from grow lights and humidity from transpiration and evaporation, rudimentary temperature and humidity manipulation is possible using simple ventilation with the cooler, less humid apartment air. Limited HVAC was implemented using a cheap temperature and humidity sensor (the AM2302), a few computer fans, and a simple bang-bang control algorithm.</p><h3 id="mcetoc_1ehq2ka111dm">Controller</h3><p>All of the components mentioned so far require binary control; they are either on or off. Control of these components can be achieved with an array of low voltage relays and a micro-controller (like an Arduino). </p><p>Light control is not binary. Additional AC dimmers were added to control the brightness of the grow lights. The AC dimmers use pulse skip modulation to modify the AC sine waves transferred to the LEDs and are controlled via pulse width modulation from a micro-controller or other real-time control device.</p><p>Because system parameters do not change much, open-loop control works fairly well. However some water level sensors are added for additional safety in preventing overflow conditions and detecting leaks.</p><h2 id="mcetoc_1ehcpsmpj1ct">Electrical Design</h2><h3 id="mcetoc_1ehcpsmpj1cv">Light</h3><p>As mentioned in the introduction, there are a number of considerations when designing lighting for an indoor grow system.</p><ul><li>The light needs to be bright enough to maximize grow.</li><li>The light brightness needs to be variable to control growth</li><li>The spectral power distribution of the light needs to be variable to control growth</li><li>Lighting needs to be uniform so that growth is even</li><li>Radiated heat needs to be removed to prevent issues like tip burn, this is done by adjust grow light height and providing adequate ventilation</li></ul><h4 id="mcetoc_1ehq2ka111dn">Brightness</h4><p>Brightness is a complicated topic that has been oversimplified in the public domain to mean Watts or Lumens. Brightness is actually a perceived phenomena that depends on the emission spectrum of a light source and the sensitivity of a receiver/sensor. Brightness for humans is not the same as brightness for plants. Therefore we need a more neutral way to measure light, such as density of photons per area.</p><ul><li>Micromols (<span class="ILfuVd NA6bn"><span class="hgKElc">µmol) - measurement of the number of photons</span></span></li><li>Photosynthetic Active Radiation (PAR) - radiation that is used by plants for photosythesis, generally wavelengths of 400-700nm. (Human vision sensitivity is close to a normal distribution over the 500-600nm spectrum)</li><li>Photosythetic Photon Flux - measuring the micromols of PAR<span class="ILfuVd NA6bn"><span class="hgKElc"> per unit of time (µmol/s) (most similar to Lumens)</span></span></li><li>Photosynthetic Photon Flux Density (PPFD) - measuring the micromols of PAR in a given surface area<span class="ILfuVd NA6bn"><span class="hgKElc"> per unit of time </span></span>(<span class="ILfuVd NA6bn"><span class="hgKElc">µmol/m^2/s) </span></span>(most similar to lux which is lumens per area). This is a measurement of how much light is actually reaching the plants (and available for photosynthesis).</li></ul><figure class="post__image post__image--center"><img loading="lazy" src="https://1gt3sd9flvb3kwgha3wmyhbu-wpengine.netdna-ssl.com/wp-content/uploads/2019/11/Photosynthetic-light-response-curves-1-1.jpg" data-is-external-image="true" alt="" width="1230" height="447"></figure><p>Even PPFD is not a perfect measurement because plants sensitivity to light varies over the spectrum and sometimes even falls outside the normal PAR range. For example, UV emission (&lt;400nm) had been shown to play a vital role in everything from THC content in cannabis to phytochemical content in basil.</p><p>So remember how I said that brightness has been oversimplified in the public domain? This is the challenge when trying to source cheaper, consumer targeted grow lights. Most consumer level grow lights are specified in Watts or Lumens, which as we know do not accurately specify the parameters we care about.</p><p>Therefore we need a way to approximate PPFD from the specs that are given, such as Watts or Lumens. While this will be very inaccurate, it is the best we have when the specs are not available. The steps to do this are</p><ol><li>Convert Watts to Lumens<ol><li>In the worst case scenario you can use average Lumens/Watt for the given light technology (hallide/sodium/LED). Lumens/Watt is also a general measure of light efficiency (light output / total energy input)</li></ol></li><li>Convert Lumens to PPF (Approximation)<ol><li>Lumens is a unit based on the human eye's sensitivity to light, which is a distribution of a limited spectrum of light. Converting a spectral power distribution (SPD) to lumens is a lossy process. We really need the SPD to calculate an accurate PPF.</li><li>Therefore, we need to approximate the SPD of the original light source and use lumens to back calculate PPF. There are <a href="https://www.waveformlighting.com/horticulture/convert-lumens-to-ppf-online-calculator" target="_blank" rel="noopener noreferrer">online calculators</a> that can do this.</li></ol></li><li>Determine PPFD based on distance and light optical characteristics (lens/reflector)<ol><li>This is where we actually design something</li></ol></li></ol><figure class="post__image post__image--center"><img loading="lazy" src="https://gossen-photo.de/wp-content/uploads/2018/11/Grafic_Human_Plant-1024x611.jpg" data-is-external-image="true" alt="" width="1024" height="611"><figcaption>The problem with converting lumens to PPF</figcaption></figure><p> </p><h4 id="mcetoc_1ehq2ka111do"><strong>Designing for PPFD</strong></h4><p>Based on <a href="#non-existing-post-with-id-26">CEA science</a>, we know that plants need anywhere from 200-1000 PPFD based on the maturity of the plant and the concentration of carbon dioxide. There are a few ways to go about finding or designing grow lights to meet these demands.</p><p>The first is to buy a grow light, which can be absurdly expensive ($1000+). Professional grow lights will provide spectral power distribution, PPF, light uniformity charts, and even PPFD charts for given light distances. This makes our job easy.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://www.sanlight.com/wp-content/uploads/2017/08/PPFD_NDL_Philips-Master-Green-Power_600W@500mm_zelt_12m2.jpg" data-is-external-image="true" alt="" width="365" height="383"></figure><p>The second option is to build your own grow light where you will need to consider choices for light technology, lenses/reflectors, physical spacing, and heat dissipation. The aim is to provide uniform light which can be accomplished by lens/reflector design/choice or by using more sources of light (many small lights vs one big light).</p><p>uFarm is an indoor grow system with limited vertical space. LEDs or full spectrum flourescents are the best options because they are compact and they limit the amount of infrared radiation. LEDs are generally more efficient because the wavelength can be more finely tailored to the plants requirements and growth stage.</p><p>After designing my own grow lights I can confidently say that it is probably best to invest in a good grow light (unless you are great at making PCBs and plan to open-source the design).</p><h3 id="mcetoc_1ehcpsmpj1d0">Power/Signal Distribution</h3><p>Below is the simplified circuit diagram for the prototype.</p><p>There are four main parameters that determine component needs.</p><ul><li>Power type (AC vs DC)</li><li>Voltage (120V, 12V, 5V)</li><li>Power requirements (Wire ampacity)</li><li>Data Signal requirements (single wire vs multiwire, bandwidth and interference)</li></ul><p>Actuated components have a range of power needs including 120VAC, 12VDC, and 5VDC. The micro-controller uses both I2C and simple GPIO high/low switching for actuation and control. </p><p>It can be seen that the microcontroller uses multi-channel relays (solenoid switches) to control both AC components like the sump and DC components like the fans and valves. This allows the tiny microcontroller to switch large amounts of power/current at higher voltages.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://blog.garrettdowd.com/media/posts/27/Aquaponic-Circuit-Diagram.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponic-Circuit-Diagram-xs.png 384w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponic-Circuit-Diagram-sm.png 600w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponic-Circuit-Diagram-md.png 768w, https://blog.garrettdowd.com/media/posts/27/responsive/Aquaponic-Circuit-Diagram-lg.png 1200w" alt=""></figure><h3 id="mcetoc_1ehq2ka111dp">Component Stack</h3><p>I am too lazy to make a diagram so here is a bunch of words.</p><ul><li><a href="https://robotdyn.com/ac-light-dimmer-module-1-channel-3-3v-5v-logic-ac-50-60hz-220v-110v.html" target="_blank" rel="noopener noreferrer">RobotDyn AC Dimmer</a><ul><li>This component allows us to dim AC lights using Pulse Skip Modulation. It is essentially a logic level (3.3V) solid state relay (no solenoid) with built-in zero-cross detection (detect when voltage is 0). This allows an external microcontroller to switch the light on/off at the right time, either skipping an entire sine wave or only transferring partial sine waves. Transferring partial sine waves requires consistent interrupts at the millisecond level (60Hz full sine wave, 1/120s for half wave) and consistent GPIO timing on the microsecond level (~32us for 8bit non-linear brightness control) which can be difficult or impossible with cheap microcontrollers. Skipping entire sine waves is easier, but can result in visibly flickering lights.</li></ul></li><li>ATMEGA328<ul><li>A small microcontroller that is used most famously by the Arduino Uno. It is used here to control the RobotDyn AC dimmers. It receives commands from the ESP32 over I2C.</li></ul></li><li>ESP32<ul><li>A wifi connected microcontroller that is great for DIY IOT and smart home projects.  It receives, interprets, and executes MQTT commands from higher level control software</li></ul></li><li>Server/Raspberry Pi<ul><li>This is the main brain for the system. It runs all of the software for the user interface and control logic.</li></ul></li></ul><h2 id="mcetoc_1ehcpsmpj1d1">Software</h2><p>Again, too lazy to make a diagram (sorry). Let's review the general software architecture.</p><ul><li>Embedded<ul><li>This is micro-contoller specific compiled C code that runs on the ESP32 and the ATMEGA328</li></ul></li><li>Server<ul><li>Any sort of VM/container setup works here. I use a combination of Proxmox, Unraid, Ubuntu, and Docker to manage the physical hardware.</li></ul></li><li>Frontend<br><ul><li><a href="https://www.home-assistant.io/" target="_blank" rel="noopener noreferrer">HomeAssistant</a> is a great fit for high level control and remote access of the system. It can also be used to create automations.</li><li><a href="https://nodered.org/" target="_blank" rel="noopener noreferrer">NodeRed</a> makes complex automation easier with visual flow programming.</li></ul></li><li>Backend<ul><li>Eclipse MQTT Server runs to enable communication between the Server and Embedded Controller </li><li>Letsencrypt/NGINX creates a secure reverse proxy to access the HomeAssistant instance anywhere in the world</li><li>DDNS is setup through Cloudflare to deal with residential ephemeral IP addresses</li></ul></li></ul><p> </p><h2 id="mcetoc_1ehq2ka111dq">Future Updates</h2><p>I hope to update some sections with more detailed information including</p><ul><li>design and component details</li><li>tradeoffs</li><li>alternatives</li></ul><p>But don't hold your breath. Feel free to <a href="https://garrettdowd.com">contact me</a> with specific questions!</p><p> </p></div><footer><p class="post__last-updated">This article was updated on September 16, 2020</p><div class="post__tags-share"><ul class="post__tag"><li><a href="https://blog.garrettdowd.com/t/engineering/">Engineering</a></li><li><a href="https://blog.garrettdowd.com/t/food/">Food</a></li><li><a href="https://blog.garrettdowd.com/t/projects/">Projects</a></li></ul><aside class="post__share"><button class="post__share-button js-post__share-button" aria-label="[MISSING TRANSLATION]"><svg width="32" height="32"><use xlink:href="https://blog.garrettdowd.com/assets/svg/svg-map.svg#share"></use></svg></button><div class="post__share-popup js-post__share-popup"><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fblog.garrettdowd.com%2Fufarm-or-engineering%2F&amp;title=uFarm%20%7C%20Engineering" class="js-share linkedin" title="[MISSING TRANSLATION] LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://blog.garrettdowd.com/assets/svg/svg-map.svg#linkedin"/></svg> LinkedIn</a></div></aside></div></footer></div></article><div class="post__related"><div class="wrapper wrapper--narrow"><h3 class="h5">Related posts</h3><div class="l-grid l-grid--fixed"><article class="c-card"><div class="c-card__wrapper"><figure class="c-card__image"><img src="https://blog.garrettdowd.com/media/posts/21/IMG_5656.jpg" srcset="https://blog.garrettdowd.com/media/posts/21/responsive/IMG_5656-xs.jpg 384w, https://blog.garrettdowd.com/media/posts/21/responsive/IMG_5656-sm.jpg 600w" sizes="(min-width: 600px) 14.285vw, 100vw" loading="lazy" height="947" width="710" alt=""></figure><div class="c-card__content"><header><h2 class="c-card__title"><a href="https://blog.garrettdowd.com/designing-ufarm/">uFarm | Product</a></h2></header><footer class="c-card__meta"><a href="https://blog.garrettdowd.com/t/product-management/" class="c-card__tag">Product Management</a> <time datetime="2020-09-02T14:38">September 2, 2020</time></footer></div></div></article></div></div></div></main><footer class="footer"><div class="wrapper"><div class="footer__top"><a class="logo footer__logo" href="https://blog.garrettdowd.com/"><img src="https://blog.garrettdowd.com/media/website/Garrett-Dowd-SF-2-01-svg.svg" alt="Garrett Dowd"></a></div><div class="footer__bottom"><div class="footer__copyright">&copy; 2020 Powered by <a href="https://getpublii.com" target="_blank" rel="noopener noreferrer nofollow">Publii Static CMS</a></div><div class="footer__social"><a href="https://www.instagram.com/garrett.dowd/" aria-label="Instagram" class="instagram"><svg><use xlink:href="https://blog.garrettdowd.com/assets/svg/svg-map.svg#instagram"/></svg> </a><a href="https://www.linkedin.com/in/garrettdowd/" aria-label="LinkedIn" class="linkedin"><svg><use xlink:href="https://blog.garrettdowd.com/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></div><button class="footer__bttop js-footer__bttop"><svg aria-hidden="true"><use xlink:href="https://blog.garrettdowd.com/assets/svg/svg-map.svg#toparrow"/></svg></button></footer><script defer="defer" src="https://blog.garrettdowd.com/assets/js/infinite-scroll.pkgd.min.js?v=4dd9a5c6d0be090b107ed878587f0039"></script><script>window.publiiThemeMenuConfig = { mobileMenuMode: 'sidebar', animationSpeed: 300, submenuWidth: 'auto', doubleClickTime: 500, mobileMenuExpandableSubmenus: true, relatedContainerForOverlayMenuSelector: '.navbar', };</script><script defer="defer" src="https://blog.garrettdowd.com/assets/js/scripts.min.js?v=ea30e966488ea4e09df508f547988da0"></script><script>function publiiDetectLoadedImages () {
         var images = document.querySelectorAll('img[loading]:not(.is-loaded)');
         for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                  images[i].classList.add('is-loaded');
                  images[i].parentNode.classList.add('is-loaded');
            } else {
                  images[i].addEventListener('load', function () {
                     this.classList.add('is-loaded');
                     this.parentNode.classList.add('is-loaded');
                  }, false);
            }
         }
      }
      publiiDetectLoadedImages();</script><script defer="defer" src="https://blog.garrettdowd.com/assets/js/photoswipe.min.js?v=017385b552f7e0d979e2e2fe6f324015"></script><script defer="defer" src="https://blog.garrettdowd.com/assets/js/photoswipe-ui-default.min.js?v=d067f0883540b1ddda0e2c9ad1b14260"></script><script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
          linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
          if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
          item.el=figureEl;items.push(item);}
          return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
          var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
          if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
          nodeIndex++;}
          if(index>=0){openPhotoSwipe(index,clickedGallery);}
          return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
          var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
          var pair=vars[i].split('=');if(pair.length<2){continue;}
          params[pair[0]]=pair[1];}
          if(params.gid){params.gid=parseInt(params.gid,10);}
          return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
          mainClass:'pswp--dark',
          preload: [1,2],
          hideAnimationDuration:200,
          showAnimationDuration:0,
          bgOpacity: 0.7,
          showHideOpacity:true,
          closeOnScroll: true,
          arrowKeys: true,
          closeEl: true,
          captionEl: true,
          fullscreenEl: true,
          zoomEl: true,
          shareEl: true,
          counterEl: true,
          arrowEl: true,
          preloaderEl: true
          };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
          if(isNaN(options.index)){return;}
          if(disableAnimation){options.showAnimationDuration=0;}
          gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
          var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};initPhotoSwipeFromDOM('.gallery');</script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button><button class="pswp__button pswp__button--share" title="Share"></button><button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button><button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></body></html>